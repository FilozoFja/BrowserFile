@model BrowserFile.Models.ViewModels.FileViewModel;

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>

<!-- Breadcrumb navigation -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a asp-controller="Folder" asp-action="Index">
                <i class="fas fa-home"></i> Folders
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">@Model.FolderName</li>
    </ol>
</nav>

<ul class="nav nav-pills pt-2">
    <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="pill" href="#mainPage">Files</a>
    </li>
    <li>
        <a class="nav-link" data-bs-toggle="pill" href="#uploadFile">Upload file</a>
    </li>
    <li>
        <a class="nav-link" data-bs-toggle="pill" href="#manageFiles">Manage files</a>
    </li>
</ul>

<div class="tab-content mt-3">
    <!-- Main Files Tab -->
    <div class="tab-pane fade show active" id="mainPage">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Files in @Model.FolderName</h3>
            <div>
                <button class="btn btn-outline-secondary btn-sm" id="listView">
                    <i class="fas fa-list"></i> List
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="gridView">
                    <i class="fas fa-th"></i> Grid
                </button>
            </div>
        </div>

        @if (Model.Files.Any())
        {
            <!-- Grid View -->
            <div id="filesGrid" class="row">
                @foreach (var file in Model.Files)
                {
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="card h-100 file-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="file-icon">
                                        @switch (file.FileExtension?.ToLower())
                                        {
                                            case ".pdf":
                                                <i class="fas fa-file-pdf text-danger fa-2x"></i>
                                                break;
                                            case ".doc":
                                            case ".docx":
                                                <i class="fas fa-file-word text-primary fa-2x"></i>
                                                break;
                                            case ".xls":
                                            case ".xlsx":
                                                <i class="fas fa-file-excel text-success fa-2x"></i>
                                                break;
                                            case ".jpg":
                                            case ".jpeg":
                                            case ".png":
                                            case ".gif":
                                                <i class="fas fa-file-image text-info fa-2x"></i>
                                                break;
                                            case ".zip":
                                            case ".rar":
                                                <i class="fas fa-file-archive text-warning fa-2x"></i>
                                                break;
                                            default:
                                                <i class="fas fa-file text-secondary fa-2x"></i>
                                                break;
                                        }
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <form asp-action="ToggleStar" asp-route-id="@file.Id" asp-route-folderId="@Model.CurrentFolderId" method="post" style="display: inline;">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="dropdown-item">
                                                        <i class="fas fa-star @(file.IsStarred ? "text-warning" : "")"></i>
                                                        @(file.IsStarred ? "Unstar" : "Star")
                                                    </button>
                                                </form>
                                            </li>
                                            <li><button class="dropdown-item" onclick="showRenameModal('@file.Id', '@file.Name')">
                                                <i class="fas fa-edit"></i> Rename
                                            </button></li>
                                            <li><button class="dropdown-item" onclick="showMoveModal('@file.Id')">
                                                <i class="fas fa-arrows-alt"></i> Move
                                            </button></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <form asp-action="MoveToTrash" asp-route-id="@file.Id" asp-route-folderId="@Model.CurrentFolderId" method="post" style="display: inline;">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Move file to trash?')">
                                                        <i class="fas fa-trash"></i> Move to Trash
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <h6 class="card-title text-truncate" title="@file.Name">@file.Name</h6>
                                <small class="text-muted d-block">Size: @file.Size</small>
                                <small class="text-muted d-block">Extension: @file.FileExtension</small>
                                <small class="text-muted d-block">Added by: @file.WhoAdded</small>
                                <small class="text-muted">Created: @file.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                @if (file.IsStarred)
                                {
                                    <div class="mt-1">
                                        <i class="fas fa-star text-warning"></i>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- List View -->
            <div id="filesList" class="d-none">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Size</th>
                                <th>Type</th>
                                <th>Added by</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var file in Model.Files)
                            {
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            @switch (file.FileExtension?.ToLower())
                                            {
                                                case ".pdf":
                                                    <i class="fas fa-file-pdf text-danger me-2"></i>
                                                    break;
                                                case ".doc":
                                                case ".docx":
                                                    <i class="fas fa-file-word text-primary me-2"></i>
                                                    break;
                                                case ".xls":
                                                case ".xlsx":
                                                    <i class="fas fa-file-excel text-success me-2"></i>
                                                    break;
                                                case ".jpg":
                                                case ".jpeg":
                                                case ".png":
                                                case ".gif":
                                                    <i class="fas fa-file-image text-info me-2"></i>
                                                    break;
                                                case ".zip":
                                                case ".rar":
                                                    <i class="fas fa-file-archive text-warning me-2"></i>
                                                    break;
                                                default:
                                                    <i class="fas fa-file text-secondary me-2"></i>
                                                    break;
                                            }
                                            @file.Name
                                            @if (file.IsStarred)
                                            {
                                                <i class="fas fa-star text-warning ms-1"></i>
                                            }
                                        </div>
                                    </td>
                                    <td>@file.Size</td>
                                    <td>@file.FileExtension</td>
                                    <td>@file.WhoAdded</td>
                                    <td>@file.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <form asp-action="ToggleStar" asp-route-id="@file.Id" asp-route-folderId="@Model.CurrentFolderId" method="post" style="display: inline;">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="dropdown-item">
                                                            <i class="fas fa-star @(file.IsStarred ? "text-warning" : "")"></i>
                                                            @(file.IsStarred ? "Unstar" : "Star")
                                                        </button>
                                                    </form>
                                                </li>
                                                <li><button class="dropdown-item" onclick="showRenameModal('@file.Id', '@file.Name')">
                                                    <i class="fas fa-edit"></i> Rename
                                                </button></li>
                                                <li><button class="dropdown-item" onclick="showMoveModal('@file.Id')">
                                                    <i class="fas fa-arrows-alt"></i> Move
                                                </button></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <form asp-action="MoveToTrash" asp-route-id="@file.Id" asp-route-folderId="@Model.CurrentFolderId" method="post" style="display: inline;">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Move file to trash?')">
                                                            <i class="fas fa-trash"></i> Move to Trash
                                                        </button>
                                                    </form>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                <p class="text-muted">No files in this folder yet.</p>
                <a class="btn btn-primary" data-bs-toggle="pill" href="#uploadFile">Upload your first file</a>
            </div>
        }
    </div>

    <!-- Upload File Tab -->
    <div class="tab-pane fade w-50" id="uploadFile">
        <h3>Upload file</h3>
        <form asp-action="CreateFolder" method="post" enctype="multipart/form-data">
            <input type="hidden" asp-for="CurrentFolderId" />
            
            <div class="mb-3">
                <label class="form-label">Choose file:</label>
                <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" name="file" class="d-none" onchange="updateFileName()" />
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted"></i>
                    </div>
                    <p class="mb-1">Click to select file or drag and drop</p>
                    <small class="text-muted">Maximum file size: 100MB</small>
                </div>
                <div id="selectedFile" class="mt-2 d-none">
                    <div class="alert alert-info">
                        <i class="fas fa-file"></i> <span id="fileName"></span>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">
                <i class="fas fa-upload"></i> Upload file
            </button>
        </form>
    </div>

    <!-- Manage Files Tab -->
    <div class="tab-pane fade" id="manageFiles">
        <h3>Manage files</h3>
        @if (Model.Files.Any())
        {
            <div class="row">
                @foreach (var file in Model.Files)
                {
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="me-2">
                                        @switch (file.FileExtension?.ToLower())
                                        {
                                            case ".pdf":
                                                <i class="fas fa-file-pdf text-danger fa-2x"></i>
                                                break;
                                            case ".doc":
                                            case ".docx":
                                                <i class="fas fa-file-word text-primary fa-2x"></i>
                                                break;
                                            case ".xls":
                                            case ".xlsx":
                                                <i class="fas fa-file-excel text-success fa-2x"></i>
                                                break;
                                            case ".jpg":
                                            case ".jpeg":
                                            case ".png":
                                            case ".gif":
                                                <i class="fas fa-file-image text-info fa-2x"></i>
                                                break;
                                            default:
                                                <i class="fas fa-file text-secondary fa-2x"></i>
                                                break;
                                        }
                                    </div>
                                    <div>
                                        <h6 class="card-title mb-0">@file.Name</h6>
                                        <small class="text-muted">@file.Size</small>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="showRenameModal('@file.Id', '@file.Name')">
                                        <i class="fas fa-edit"></i> Rename
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showMoveModal('@file.Id')">
                                        <i class="fas fa-arrows-alt"></i> Move
                                    </button>
                                    <form asp-action="DeleteFile" asp-route-id="@file.Id" asp-route-folderId="@Model.CurrentFolderId" method="post" style="display: inline;">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this file?')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <p>No files to manage.</p>
        }
    </div>
</div>

<!-- Rename Modal -->
<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rename file</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="renameForm" method="post">
                <div class="modal-body">
                    <input type="hidden" id="renameFileId" name="id" />
                    <input type="hidden" name="folderId" value="@Model.CurrentFolderId" />
                    <div class="mb-3">
                        <label class="form-label">New name:</label>
                        <input type="text" id="newFileName" name="newName" class="form-control" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Rename</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Move Modal -->
<div class="modal fade" id="moveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Move file to folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="moveForm" method="post">
                <div class="modal-body">
                    <input type="hidden" id="moveFileId" name="id" />
                    <input type="hidden" name="currentFolderId" value="@Model.CurrentFolderId" />
                    <div class="mb-3">
                        <label class="form-label">Select destination folder:</label>
                        <select name="newFolderId" class="form-select" required>
                            @foreach (var folder in Model.FolderShortModel)
                            {
                                <option value="@folder.Id">@folder.Name</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Move</button>
                </div>
            </form>
        </div>
    </div>
</div>

@{
    ViewData["Title"] = "Files - " + Model.FolderName;
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    .file-card {
        transition: transform 0.2s;
    }

    .file-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .file-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s;
    }

    .file-upload-area:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }

    .file-upload-area.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
    }

    .upload-icon {
        margin-bottom: 15px;
    }

    .table th {
        border-top: none;
        font-weight: 600;
    }

    .dropdown-menu {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
</style>

<script>
    // Switch to upload tab
    function switchToUploadTab() {
        // Remove active class from current tab
        document.querySelector('.nav-link.active').classList.remove('active');
        document.querySelector('.tab-pane.show.active').classList.remove('show', 'active');
        
        // Add active class to upload tab
        document.querySelector('a[href="#uploadFile"]').classList.add('active');
        document.getElementById('uploadFile').classList.add('show', 'active');
    }

    // View toggle
    document.getElementById('listView').addEventListener('click', function() {
        document.getElementById('filesGrid').classList.add('d-none');
        document.getElementById('filesList').classList.remove('d-none');
        this.classList.add('btn-secondary');
        this.classList.remove('btn-outline-secondary');
        document.getElementById('gridView').classList.remove('btn-secondary');
        document.getElementById('gridView').classList.add('btn-outline-secondary');
    });

    document.getElementById('gridView').addEventListener('click', function() {
        document.getElementById('filesList').classList.add('d-none');
        document.getElementById('filesGrid').classList.remove('d-none');
        this.classList.add('btn-secondary');
        this.classList.remove('btn-outline-secondary');
        document.getElementById('listView').classList.remove('btn-secondary');
        document.getElementById('listView').classList.add('btn-outline-secondary');
    });

    // File upload
    function updateFileName() {
        const fileInput = document.getElementById('fileInput');
        const selectedFileDiv = document.getElementById('selectedFile');
        const fileName = document.getElementById('fileName');
        
        if (fileInput.files.length > 0) {
            fileName.textContent = fileInput.files[0].name;
            selectedFileDiv.classList.remove('d-none');
        } else {
            selectedFileDiv.classList.add('d-none');
        }
    }

    // Drag and drop
    const uploadArea = document.querySelector('.file-upload-area');
    
    if (uploadArea) {
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                updateFileName();
            }
        });
    }

    // Toggle star
    function toggleStar(fileId, folderId) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '@Url.Action("ToggleStar", "File")';
        
        const tokenInput = document.createElement('input');
        tokenInput.type = 'hidden';
        tokenInput.name = '__RequestVerificationToken';
        tokenInput.value = document.querySelector('input[name="__RequestVerificationToken"]').value;
        
        const idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.name = 'id';
        idInput.value = fileId;
        
        const folderInput = document.createElement('input');
        folderInput.type = 'hidden';
        folderInput.name = 'folderId';
        folderInput.value = folderId;
        
        form.appendChild(tokenInput);
        form.appendChild(idInput);
        form.appendChild(folderInput);
        document.body.appendChild(form);
        form.submit();
    }

    // Move to trash
    function moveToTrash(fileId, folderId) {
        if (confirm('Move file to trash?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("MoveToTrash", "File")';
            
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = '__RequestVerificationToken';
            tokenInput.value = document.querySelector('input[name="__RequestVerificationToken"]').value;
            
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = fileId;
            
            const folderInput = document.createElement('input');
            folderInput.type = 'hidden';
            folderInput.name = 'folderId';
            folderInput.value = folderId;
            
            form.appendChild(tokenInput);
            form.appendChild(idInput);
            form.appendChild(folderInput);
            document.body.appendChild(form);
            form.submit();
        }
    }

    // Delete file (for manage tab)
    function deleteFile(fileId, folderId) {
        if (confirm('Are you sure you want to delete this file? This action cannot be undone.')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("DeleteFile", "File")';
            
            // Add method override for DELETE
            const methodInput = document.createElement('input');
            methodInput.type = 'hidden';
            methodInput.name = '_method';
            methodInput.value = 'DELETE';
            
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = '__RequestVerificationToken';
            tokenInput.value = document.querySelector('input[name="__RequestVerificationToken"]').value;
            
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = fileId;
            
            const folderInput = document.createElement('input');
            folderInput.type = 'hidden';
            folderInput.name = 'folderId';
            folderInput.value = folderId;
            
            form.appendChild(methodInput);
            form.appendChild(tokenInput);
            form.appendChild(idInput);
            form.appendChild(folderInput);
            document.body.appendChild(form);
            form.submit();
        }
    }

    // Rename modal
    function showRenameModal(fileId, currentName) {
        document.getElementById('renameFileId').value = fileId;
        document.getElementById('newFileName').value = currentName;
        document.getElementById('renameForm').action = '@Url.Action("RenameFile", "File")';
        new bootstrap.Modal(document.getElementById('renameModal')).show();
    }

    // Move modal
    function showMoveModal(fileId) {
        document.getElementById('moveFileId').value = fileId;
        document.getElementById('moveForm').action = '@Url.Action("MoveFile", "File")';
        new bootstrap.Modal(document.getElementById('moveModal')).show();
    }

    // Toast notifications for TempData
    @if (TempData["Success"] != null)
    {
        <text>
        toastr.success('@TempData["Success"]');
        </text>
    }

    @if (TempData["Error"] != null)
    {
        <text>
        toastr.error('@TempData["Error"]');
        </text>
    }
</script>