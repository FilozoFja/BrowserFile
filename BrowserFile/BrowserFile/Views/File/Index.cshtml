@model BrowserFile.Models.ViewModels.FileViewModel

@{
    ViewData["Title"] = "Files - " + Model.FolderName;
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css">

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a asp-controller="Folder" asp-action="Index">
                <i class="fas fa-home"></i> Folders
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">@Model.FolderName</li>
    </ol>
</nav>

<div id="bulkActions" class="alert alert-info d-none mb-3">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <strong><span id="selectedCount">0</span> files selected</strong>
        </div>
        <div>
            <button class="btn btn-sm btn-outline-primary me-2" onclick="showBulkMoveModal()">
                <i class="fas fa-arrows-alt"></i> Move Selected
            </button>
            <button class="btn btn-sm btn-outline-danger me-2" onclick="bulkMoveToTrash()">
                <i class="fas fa-trash"></i> Move to Trash
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="bulkDeleteFiles()">
                <i class="fas fa-times"></i> Delete Selected
            </button>
            <button class="btn btn-sm btn-secondary ms-2" onclick="clearSelection()">
                <i class="fas fa-times"></i> Clear Selection
            </button>
        </div>
    </div>
</div>

<ul class="nav nav-pills pt-2">
    <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="pill" href="#mainPage">Files</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#uploadFile">Upload file</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="pill" href="#manageFiles">Manage files</a>
    </li>
    <li class="ms-auto">
        <button class="btn btn-outline-secondary btn-sm" id="toggleBulkSelect">
            <i class="fas fa-check-square"></i> Select Multiple
        </button>
    </li>
</ul>

<div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="mainPage">

        @if (Model.Files.Any())
        {
            <div id="filesGrid" class="row">
                @foreach (var file in Model.Files)
                {
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="card h-100 file-card" data-file-id="@file.Id">
                            <div class="file-checkbox d-none">
                                <input type="checkbox" class="file-select-checkbox" value="@file.Id"
                                       onchange="updateBulkSelection()">
                            </div>

                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="file-icon">
                                        @switch (file.FileExtension?.ToLower())
                                        {
                                            case ".pdf":
                                                <i class="fas fa-file-pdf text-danger fa-2x"></i>
                                                break;
                                            case ".doc":
                                            case ".docx":
                                                <i class="fas fa-file-word text-primary fa-2x"></i>
                                                break;
                                            case ".xls":
                                            case ".xlsx":
                                                <i class="fas fa-file-excel text-success fa-2x"></i>
                                                break;
                                            case ".jpg":
                                            case ".jpeg":
                                            case ".png":
                                            case ".gif":
                                                <i class="fas fa-file-image text-info fa-2x"></i>
                                                break;
                                            case ".zip":
                                            case ".rar":
                                                <i class="fas fa-file-archive text-warning fa-2x"></i>
                                                break;
                                            default:
                                                <i class="fas fa-file text-secondary fa-2x"></i>
                                                break;
                                        }
                                    </div>
                                    @if (file.IsStarred)
                                    {
                                        <div class="mt-1">
                                            <i class="fas fa-star text-warning"></i>
                                        </div>
                                    }
                                </div>
                                <h6 class="card-title text-truncate" title="@file.Name">@file.Name</h6>
                                <small class="text-muted d-block">Size: @file.Size</small>
                                <small class="text-muted d-block">Extension: @file.FileExtension</small>
                                <small class="text-muted d-block">Added by: @file.WhoAdded</small>
                                <small class="text-muted">Created: @file.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                            </div>
                            <div class="card-footer p-2 bg-light">
                                <div class="btn-group w-100" role="group">
                                    <a asp-controller="File" asp-action="Preview" asp-route-id="@file.Id"
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye"></i> Podgląd
                                    </a>
                                    <a asp-action="DownloadFile" asp-route-id="@file.Id"
                                       class="btn btn-outline-success btn-sm">
                                        <i class="fas fa-download"></i> Pobierz
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                <p class="text-muted">No files in this folder yet.</p>
                <a class="btn btn-primary" data-bs-toggle="pill" href="#uploadFile">Upload your first file</a>
            </div>
        }
    </div>

    <div class="tab-pane fade w-50" id="uploadFile">
        <h3>Upload file</h3>
        <form asp-action="CreateFolder" method="post" enctype="multipart/form-data">
            <input type="hidden" asp-for="CurrentFolderId" />

            <div class="mb-3">
                <label class="form-label">Choose file:</label>
                <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" name="file" class="d-none" onchange="updateFileName()" />
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted"></i>
                    </div>
                    <p class="mb-1">Click to select file or drag and drop</p>
                    <small class="text-muted">Maximum file size: 100MB</small>
                </div>
                <div id="selectedFile" class="mt-2 d-none">
                    <div class="alert alert-info">
                        <i class="fas fa-file"></i> <span id="fileName"></span>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">
                <i class="fas fa-upload"></i> Upload file
            </button>
        </form>
    </div>

    <div class="tab-pane fade" id="manageFiles">
        <h3>Manage files</h3>
        @if (Model.Files.Any())
        {
            <div class="row">
                @foreach (var file in Model.Files)
                {
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="me-2">
                                        @switch (file.FileExtension?.ToLower())
                                        {
                                            case ".pdf":
                                                <i class="fas fa-file-pdf text-danger fa-2x"></i>
                                                break;
                                            case ".doc":
                                            case ".docx":
                                                <i class="fas fa-file-word text-primary fa-2x"></i>
                                                break;
                                            case ".xls":
                                            case ".xlsx":
                                                <i class="fas fa-file-excel text-success fa-2x"></i>
                                                break;
                                            case ".jpg":
                                            case ".jpeg":
                                            case ".png":
                                            case ".gif":
                                                <i class="fas fa-file-image text-info fa-2x"></i>
                                                break;
                                            default:
                                                <i class="fas fa-file text-secondary fa-2x"></i>
                                                break;
                                        }
                                    </div>
                                    <div>
                                        <h6 class="card-title mb-0">@file.Name</h6>
                                        <small class="text-muted">@file.Size</small>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="showRenameModal('@file.Id', '@file.Name')">
                                        <i class="fas fa-edit"></i> Rename
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showMoveModal('@file.Id')">
                                        <i class="fas fa-arrows-alt"></i> Move
                                    </button>
                                    <form asp-action="DeleteFile" asp-route-id="@file.Id" asp-route-folderId="@Model.CurrentFolderId" method="post" style="display: inline;">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this file?')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                    <form asp-action="ToggleStar" asp-route-id="@file.Id" asp-route-folderId="@Model.CurrentFolderId" method="post" style="display: inline;">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-outline-warning btn-sm">
                                            <i class="fas fa-star"></i> Toggle Star
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <p>No files to manage.</p>
        }
    </div>
</div>

<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rename file</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="renameForm" method="post">
                <div class="modal-body">
                    <input type="hidden" id="renameFileId" name="id" />
                    <input type="hidden" name="folderId" value="@Model.CurrentFolderId" />
                    <div class="mb-3">
                        <label class="form-label">New name:</label>
                        <input type="text" id="newFileName" name="newName" class="form-control" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Rename</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="bulkMoveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Move Selected Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="bulkMoveForm" method="post" action="@Url.Action("MoveFiles", "File")">
                <div class="modal-body">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="currentFolderId" value="@Model.CurrentFolderId" />
                    <div id="selectedFilesList"></div>

                    <div class="mb-3">
                        <label class="form-label">Select destination folder:</label>
                        <select name="newFolderId" class="form-select" required>
                            <option value="">Choose folder...</option>
                            @foreach (var folder in Model.FolderShortModel)
                            {
                                <option value="@folder.Id">@folder.Name</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Move Files</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .toggle-star-btn:hover {
    color: white;            
    background-color: #ffc107; 
    border-color: #ffc107;    
    }

    .toggle-star-btn:hover i.fas.fa-star {
        color: white;
    }

    .file-card {
        position: relative;
        transition: transform 0.2s;
        cursor: pointer;
    }

    .file-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .file-card.selected {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .file-checkbox {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background: white;
        border-radius: 4px;
        padding: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .file-select-checkbox {
        transform: scale(1.2);
    }

    .bulk-mode .single-file-actions,
    .bulk-mode .single-file-header,
    .bulk-mode .single-file-cell {
        display: none !important;
        pointer-events: none !important;
    }

    .bulk-mode .file-card .dropdown {
        display: none !important;
    }

    .bulk-mode .file-checkbox,
    .bulk-mode .bulk-select-header,
    .bulk-mode .bulk-select-cell {
        display: block !important;
    }

    .bulk-mode .file-card {
        cursor: pointer;
    }

    .file-card .dropdown {
        position: relative;
        z-index: 1050; 
    }

    .file-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s;
    }

    .file-upload-area:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }

    .file-upload-area.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
    }

    .upload-icon {
        margin-bottom: 15px;
    }

    .table th {
        border-top: none;
        font-weight: 600;
    }

    .dropdown-menu {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
</style>

<script>
    let bulkSelectMode = false;
    let selectedFiles = [];

    document.getElementById('toggleBulkSelect').addEventListener('click', function () {
        bulkSelectMode = !bulkSelectMode;
        document.body.classList.toggle('bulk-mode', bulkSelectMode);

        if (bulkSelectMode) {
            this.innerHTML = '<i class="fas fa-times"></i> Cancel Selection';
            this.classList.remove('btn-outline-secondary');
            this.classList.add('btn-outline-danger');
        } else {
            this.innerHTML = '<i class="fas fa-check-square"></i> Select Multiple';
            this.classList.remove('btn-outline-danger');
            this.classList.add('btn-outline-secondary');
            clearSelection();
        }
    });

    document.querySelectorAll('.file-card').forEach(card => {
        card.addEventListener('click', function (e) {
            if (bulkSelectMode && !e.target.closest('.dropdown')) {
                const checkbox = this.querySelector('.file-select-checkbox');
                checkbox.checked = !checkbox.checked;
                updateBulkSelection();
            }
        });
    });

    document.querySelectorAll('.nav-link[data-bs-toggle="pill"]').forEach(tabLink => {
        tabLink.addEventListener('click', function () {
            if (bulkSelectMode && (this.getAttribute('href') === '#uploadFile' || this.getAttribute('href') === '#manageFiles')) {
                document.getElementById('toggleBulkSelect').click();
            }
        });
    });

    function updateBulkSelection() {
        const checkboxes = document.querySelectorAll('.file-select-checkbox:checked');
        selectedFiles = Array.from(checkboxes).map(cb => cb.value);

        document.getElementById('selectedCount').textContent = selectedFiles.length;
        document.getElementById('bulkActions').classList.toggle('d-none', selectedFiles.length === 0);

        document.querySelectorAll('.file-card').forEach(card => {
            const checkbox = card.querySelector('.file-select-checkbox');
            card.classList.toggle('selected', checkbox && checkbox.checked);
        });
    }

    function clearSelection() {
        document.querySelectorAll('.file-select-checkbox').forEach(cb => cb.checked = false);
        updateBulkSelection();
    }

    function showBulkMoveModal() {
        if (selectedFiles.length === 0) return;

        const filesList = document.getElementById('selectedFilesList');
        filesList.innerHTML = selectedFiles.map(fileId =>
            `<input type="hidden" name="fileIds" value="${fileId}">`
        ).join('');

        new bootstrap.Modal(document.getElementById('bulkMoveModal')).show();
    }

    function updateFileName() {
        const fileInput = document.getElementById('fileInput');
        const selectedFileDiv = document.getElementById('selectedFile');
        const fileName = document.getElementById('fileName');

        if (fileInput.files.length > 0) {
            fileName.textContent = fileInput.files[0].name;
            selectedFileDiv.classList.remove('d-none');
        } else {
            selectedFileDiv.classList.add('d-none');
        }
    }

    const uploadArea = document.querySelector('.file-upload-area');
    if (uploadArea) {
        uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', e => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', e => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if(e.dataTransfer.files.length>0){
                document.getElementById('fileInput').files = e.dataTransfer.files;
                updateFileName();
            }
        });
    }

    function showRenameModal(fileId, currentName) {
        document.getElementById('renameFileId').value = fileId;
        document.getElementById('newFileName').value = currentName;
        document.getElementById('renameForm').action = '@Url.Action("RenameFile", "File")';
        new bootstrap.Modal(document.getElementById('renameModal')).show();
    }

    @if (TempData["Success"] != null) {
        <text>toastr.success('@TempData["Success"]');</text>
    }
    @if (TempData["Error"] != null) {
        <text>toastr.error('@TempData["Error"]');</text>
    }

        function bulkDeleteFiles() {
            if (selectedFiles.length === 0) return;

            if (confirm(`Permanently delete ${selectedFiles.length} selected files? This cannot be undone.`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("DeleteFiles", "File")';

                const token = document.querySelector('input[name="__RequestVerificationToken"]').cloneNode();
                form.appendChild(token);

                const folderInput = document.createElement('input');
                folderInput.type = 'hidden';
                folderInput.name = 'currentFolderId';
                folderInput.value = '@Model.CurrentFolderId';
                form.appendChild(folderInput);

                selectedFiles.forEach(fileId => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'fileIds';
                    input.value = fileId;
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();
            }
        }
</script>
